# CIG Nexus WebSocket Gateway v0.1

A minimal, transport-only WebSocket ↔ TCP gateway that bridges clients to the CIG Nexus server.

## Overview

The gateway is a stateless bridge with **no business logic, no validation, no authentication**. It exists solely to:
1. Accept WebSocket connections from clients
2. Establish TCP connections to the backend server
3. Forward WebSocket messages (JSON strings) to TCP
4. Forward TCP frames back to WebSocket as JSON strings
5. Manage connection lifecycle (1 WebSocket = 1 TCP)

## Architecture

```
┌─────────────┐
│   Client    │ (WebSocket)
└──────┬──────┘
       │ JSON string
       ↓
┌────────────────────────┐
│ WsServer (port 8080)   │ ← Main entry point
├────────────────────────┤
│ - Accepts WS conn      │
│ - Creates TcpClient    │
│ - Relays messages      │
│ - Manages lifecycle    │
└──────┬─────────────────┘
       │ Framed binary data
       ↓
┌────────────────────────┐
│ TcpClient              │
├────────────────────────┤
│ - Connects to server   │
│ - Encodes frames       │
│ - Extracts frames      │
│ - Buffers partial data │
└──────┬─────────────────┘
       │ TCP binary
       ↓
┌──────────────────┐
│ Server (port 4242)
└──────────────────┘
```

## Installation

```bash
npm install
```

Dependencies:
- `ws` - WebSocket server (runtime)
- `typescript` - Compiler (dev)
- `@types/node`, `@types/ws` - Type definitions (dev)

## Building

```bash
npm run build
```

Compiles TypeScript from `src/` to `dist/`.

## Running

### Environment Variables

- **WS_PORT** (default: 8080) - WebSocket server port
- **TCP_HOST** (default: localhost) - Backend server hostname
- **TCP_PORT** (default: 4242) - Backend server port

### Start Gateway

```bash
WS_PORT=8080 TCP_HOST=localhost TCP_PORT=4242 npm start
```

Output:
```
Starting WebSocket gateway...
WS_PORT=8080 TCP_HOST=localhost TCP_PORT=4242
WebSocket gateway listening on port 8080
```

## Message Flow

### WebSocket → TCP

1. Client sends JSON string over WebSocket
   ```javascript
   ws.send(JSON.stringify({ type: "HELLO", version: "0.1" }))
   ```

2. WsServer receives message
3. Converts string to Buffer
4. Calls TcpClient.send(buffer)
5. TcpClient encodes frame (4-byte length prefix + payload)
6. Writes framed data to TCP socket

### TCP → WebSocket

1. TcpClient receives raw TCP data
2. Appends to internal buffer
3. Calls extractFrames() to extract complete messages
4. For each frame:
   - Converts Buffer to string
   - Sends as WebSocket message
5. Preserves remaining partial frame for next data event

## Constraints & Design Decisions

### Transport-Only
- No JSON field validation
- No protocol type inspection
- No message filtering or transformation
- Messages pass through untouched (except encoding/decoding)

### Error Handling
- TCP connection failure: Send gateway error message to WebSocket, then close both
- TCP disconnection: Close WebSocket
- WebSocket disconnection: Close TCP
- Frame size invalid (0 bytes or > 1MB): Throw error, close both connections
- Partial frames: Buffered gracefully (not an error)

### 1:1 Mapping
- Each WebSocket connection creates exactly one TCP connection
- Connections close together (when either side closes)
- No connection pooling or reuse

## Implementation Details

### File Structure

```
src/
├── index.ts              # Entry point, env vars, WsServer startup
├── types.ts              # TypeScript type definitions (unused in v0.1)
├── ws/
│   └── WsServer.ts       # WebSocket server, route logic
├── tcp/
│   └── TcpClient.ts      # TCP connection wrapper
└── protocol/
    ├── frame.ts          # Binary framing (encode/extract)
    └── parser.ts         # Placeholder for future protocol parsing

dist/                     # Compiled JavaScript (generated by build)
```

### Core Modules

**WsServer**
- Creates `ws.WebSocketServer` on configured port
- On connection: Creates TcpClient, attempts connect
- On WS message: Sends to TCP via TcpClient
- On TCP message: Sends to WS
- On disconnect: Closes both sides

**TcpClient**
- Wraps Node.js `net.Socket`
- Methods: `connect()`, `send()`, `onMessage()`, `onClose()`, `close()`
- Maintains buffer for partial frames
- Uses `extractFrames()` to parse incoming data

**frame.ts**
- `encodeFrame(payload)` - Adds 4-byte big-endian length prefix
- `extractFrames(buffer)` - Extracts all complete frames, returns remaining buffer
- Max frame size: 1MB
- Validates frame sizes (must be > 0 and <= 1MB)

## Testing

Start the server and gateway, then run:

```bash
node test-gateway.js
```

Expected output:
```
Starting test client...
✓ Connected to gateway!
Sending HELLO message...
Timeout - closing connection
```

(Note: No response expected from server v0.1 as message processing is not yet implemented.)

## Future Enhancements

- [ ] TLS/SSL support for WebSocket connections
- [ ] Connection pooling for multiple clients
- [ ] Metrics/logging integration
- [ ] Graceful shutdown on SIGTERM
- [ ] Load balancing across multiple server instances
- [ ] Client-specific routing/multiplexing

## Notes

- This gateway is **stateless**—all state lives in the backend server
- Message **ordering is preserved** (FIFO on both sides)
- **Backpressure** is not implemented—flows on WebSocket and TCP are assumed to be roughly balanced
- **No reconnection logic**—client must re-establish WebSocket connection
- **No keep-alive**—relies on OS TCP/WebSocket keep-alive
